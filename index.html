<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ================================================================================== -->
    <!-- SEO & META DATA                                                                    -->
    <!-- ================================================================================== -->
    <!-- UPDATED TITLE -->
    <title>HaiMail - Instant Privacy.</title>
    
    <meta name="description" content="Stop spam forever. Get a beautiful, secure, and anonymous temporary email address in one click. No signup. 100% Free.">
    <meta name="keywords" content="temp mail, temporary email, disposable email, throwaway email, anonymous email, fake mail, spam protection, privacy, secure inbox, HaiMail, 10 minute mail">
    <meta name="author" content="HaldarAi">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <link rel="canonical" href="https://haimailwb.vercel.app/">

    <!-- SITEMAP TAG -->
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">

    <!-- Google Search Console Verification -->
    <meta name="google-site-verification" content="R7X62f4tJJ8vf-WnsSdx1JVOrFLgkgK5AHiFm_8PhNI" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://haimailwb.vercel.app/">
    <meta property="og:title" content="HaiMail - Instant Privacy.">
    <meta property="og:description" content="Stop spam forever. Get a beautiful, secure, and anonymous temporary email address in one click. No signup. 100% Free.">
    <meta property="og:image" content="https://haimailwb.vercel.app/favicon.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:url" content="https://haimailwb.vercel.app/">
    <meta name="twitter:title" content="HaiMail - Instant Privacy.">
    <meta name="twitter:description" content="Stop spam forever. Get a beautiful, secure, and anonymous temporary email address in one click.">
    <meta name="twitter:image" content="https://haimailwb.vercel.app/favicon.png">

    <!-- Icons & Manifest -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="shortcut icon" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#fff0f5">
    
    <!-- ================================================================================== -->
    <!-- APP RESOURCES                                                                      -->
    <!-- ================================================================================== -->
    
    <!-- Google Fonts and Material Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* --- THEME CONFIGURATION --- */
        :root {
            /* Light Theme (Default - Pink/Peach) */
            --bg-primary: #fff0f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #ffe4ea;
            --bg-code: #fdf2f4;
            --bg-hover: #ffcbd7;
            
            --text-primary: #4a3b42;
            --text-secondary: #967d86;
            --text-active: #ff4785; /* Hot Pink */
            
            --border-color: #fbcfe8;
            --error-color: #ff5252;
            
            --sidebar-width: 260px;
            --font-family: 'Inter', sans-serif;
            --font-family-code: 'Roboto Mono', monospace;

            /* Brand Gradient */
            --brand-gradient: linear-gradient(135deg, #ff4785 0%, #ff9a7b 100%);
            --brand-shadow: 0 4px 15px rgba(255, 71, 133, 0.3);
            
            --spinner-color: rgba(255,255,255,0.3);
        }

        /* Dark Theme Variables */
        [data-theme="dark"] {
            --bg-primary: #121212;       /* Deep Black */
            --bg-secondary: #1e1e1e;     /* Dark Grey Card */
            --bg-tertiary: #2c2c2c;      /* Hover state */
            --bg-code: #181818;          /* Code block background */
            --bg-hover: #333333;
            
            --text-primary: #e0e0e0;     /* Off-white text */
            --text-secondary: #a0a0a0;   /* Muted grey text */
            /* --text-active stays pink for pop */
            
            --border-color: #333333;     /* Dark borders */
            --brand-shadow: 0 4px 20px rgba(255, 71, 133, 0.15); /* Softer shadow in dark mode */
            
            --spinner-color: rgba(255,255,255,0.1);
        }

        /* --- Base & Reset --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg-primary); color: var(--text-primary); font-family: var(--font-family); font-size: 16px; transition: background-color 0.3s, color 0.3s; }
        button, a { background: none; border: none; cursor: pointer; color: inherit; text-decoration: none; font-family: inherit; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; font-size: 20px; color: var(--text-secondary); transition: color 0.2s; user-select: none; }

        /* --- Main Layout --- */
        .app-container { display: flex; width: 100%; height: 100%; }
        .main-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .main-header { display: flex; align-items: center; padding: 12px 24px; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); flex-shrink: 0; position: sticky; top: 0; z-index: 100; transition: background-color 0.3s; }
        .header-title { font-size: 1.1rem; font-weight: 700; margin-left: 12px; color: var(--text-active); }
        .icon-button { padding: 8px; border-radius: 50%; display: flex; transition: background-color 0.2s; }
        .icon-button:hover { background-color: var(--bg-tertiary); }
        .icon-button .material-symbols-outlined { color: var(--text-active); }
        .content-area { flex-grow: 1; overflow: hidden; position: relative; }

        /* --- Sidebar --- */
        #left-sidebar { position: fixed; top: 0; left: 0; height: 100%; width: var(--sidebar-width); max-width: 85%; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 1001; transform: translateX(-100%); transition: transform 0.3s ease-in-out, background-color 0.3s; }
        body.left-sidebar-open #left-sidebar { transform: translateX(0); }
        .sidebar-content { padding: 16px; display: flex; flex-direction: column; flex-grow: 1; overflow-y: auto; }
        
        .sidebar-header { font-size: 1.75rem; font-weight: 800; padding: 12px; margin-bottom: 24px; display: flex; align-items: center; gap: 8px; }
        .sidebar-header span { background: var(--brand-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .sidebar-nav a, .sidebar-nav button { font-size: 1em; display: flex; align-items: center; gap: 16px; padding: 12px; border-radius: 12px; font-weight: 500; transition: all 0.2s; color: var(--text-secondary); text-align: left; width: 100%; margin-bottom: 6px;}
        .sidebar-nav a:hover, .sidebar-nav button:hover { background-color: var(--bg-tertiary); color: var(--text-active); }
        .sidebar-nav a.active, .sidebar-nav button.active { background: var(--brand-gradient); color: white; box-shadow: var(--brand-shadow); }
        .sidebar-nav .material-symbols-outlined { color: inherit; } 
        .sidebar-nav a:hover .material-symbols-outlined, .sidebar-nav button:hover .material-symbols-outlined { color: var(--text-active); }
        .sidebar-nav a.active .material-symbols-outlined, .sidebar-nav button.active .material-symbols-outlined { color: white; }
        
        .sidebar-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border-color); }

        /* --- Home Screen / Dashboard --- */
        .screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .screen.active { display: block; }
        #home-screen, #history-screen, #profile-screen, #email-details-screen { overflow-y: auto; padding: 16px 8px; }
        .content-wrapper { max-width: 820px; width: 100%; margin: 0 auto; padding: 16px 0; }
        .page-header { margin-bottom: 24px; padding: 0 16px; display: flex; align-items: center; gap: 12px; }
        .page-header h2 { font-size: 1.5rem; color: var(--text-primary); }

        .dashboard-card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; margin: 0 16px 24px 16px; text-align: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); transition: background-color 0.3s; }
        .email-display { font-family: var(--font-family-code); font-size: 1.25rem; color: var(--text-active); margin: 16px 0; word-break: break-all; font-weight: 600; background: var(--bg-code); padding: 12px; border-radius: 8px; border: 1px dashed var(--border-color); }
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-top: 24px; }
        
        .btn { padding: 12px 20px; font-weight: 600; border-radius: 12px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; }
        
        .btn-primary { background: var(--brand-gradient); color: white; border: none; box-shadow: var(--brand-shadow); }
        .btn-primary:hover:not(:disabled) { opacity: 0.95; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 71, 133, 0.5); }
        
        .btn-secondary { background-color: var(--bg-secondary); color: var(--text-active); border: 2px solid var(--bg-tertiary); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-primary); border-color: var(--text-active); }
        
        .btn-danger { background-color: var(--bg-secondary); color: var(--error-color); border: 1px solid var(--error-color); }
        .btn-danger:hover { background-color: var(--bg-code); }
        
        /* --- Lists --- */
        .list-container { padding: 0 16px; }
        .history-item { display: flex; align-items: center; gap: 16px; background-color: var(--bg-secondary); border-radius: 12px; padding: 16px; border: 1px solid var(--border-color); margin-bottom: 12px; transition: all 0.2s; cursor: pointer; }
        .history-item:hover { background-color: var(--bg-tertiary); border-color: var(--text-active); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .avatar { width: 42px; height: 42px; border-radius: 50%; background: var(--brand-gradient); display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; flex-shrink: 0; box-shadow: 0 2px 8px rgba(255, 71, 133, 0.3); position: relative; }
        .avatar.new::after { content: ''; position: absolute; top: 0; right: 0; width: 12px; height: 12px; background-color: #00e676; border-radius: 50%; border: 2px solid var(--bg-secondary); }
        
        .item-content { flex-grow: 1; overflow: hidden; }
        .item-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .sender { font-weight: 700; color: var(--text-primary); font-size: 1rem; }
        .time { font-size: 0.8rem; color: var(--text-secondary); }
        .subject { font-size: 0.95rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .snippet { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }

        /* --- Details --- */
        .email-meta { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .meta-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .email-body { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; color: var(--text-primary); line-height: 1.6; word-wrap: break-word; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }

        /* --- Misc --- */
        #splash-screen { position: absolute; inset: 0; background-color: var(--bg-secondary); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .splash-icon { font-size: 64px; background: var(--brand-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .splash-loader { width: 200px; height: 6px; background: var(--bg-tertiary); border-radius: 3px; margin-top: 24px; overflow: hidden; }
        .splash-bar { height: 100%; background: var(--brand-gradient); width: 0%; animation: load 2s ease-out forwards; }
        @keyframes load { to { width: 100%; } }

        .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(20px); background-color: #333; color: white; padding: 12px 24px; border-radius: 30px; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 3000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .toast.visible { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
        .toast-btn { font-size: 0.85rem; color: #ff8e72; font-weight: 600; margin-left: 12px; padding: 4px 8px; border-radius: 4px; }
        .toast-btn:hover { background-color: rgba(255,255,255,0.1); }

        .spinner { width: 20px; height: 20px; border: 2px solid var(--spinner-color); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
        .btn-secondary .spinner { border-color: rgba(255, 71, 133, 0.3); border-top-color: var(--text-active); }
        @keyframes spin { to { transform: rotate(360deg); } }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0, 0.5); backdrop-filter: blur(4px); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        body.left-sidebar-open .overlay { opacity: 1; visibility: visible; }
        
        @media (min-width: 1024px) {
            #left-sidebar { position: static; transform: none; }
            .main-header { display: none; }
            .content-area { padding-top: 0; }
        }
        @media (max-width: 1023px) {
            .app-container { flex-direction: column; }
            .sidebar-header { justify-content: space-between; }
        }
    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash-screen">
        <span class="material-symbols-outlined splash-icon">drafts</span>
        <h1 style="font-size: 2rem; margin-top: 16px; font-weight: 800; color: var(--text-primary);">HaiMail</h1>
        <div class="splash-loader"><div class="splash-bar"></div></div>
    </div>

    <div class="app-container">
        
        <!-- Sidebar Navigation -->
        <div id="left-sidebar">
            <div class="sidebar-content">
                <div class="sidebar-header">
                    <span>HaiMail</span>
                    <!-- Close button for mobile -->
                    <button class="icon-button" id="sidebar-close" style="margin-left: auto; display: none;">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <nav class="sidebar-nav">
                    <button id="nav-home" class="active">
                        <span class="material-symbols-outlined">inbox</span> Inbox
                    </button>
                    <button id="nav-history">
                        <span class="material-symbols-outlined">history</span> History
                    </button>
                    <!-- Theme Toggle -->
                    <button id="theme-toggle">
                        <span class="material-symbols-outlined" id="theme-icon">dark_mode</span>
                        <span id="theme-text">Dark Mode</span>
                    </button>
                </nav>
            </div>
            <div class="sidebar-footer">
                <div style="padding: 0 16px 16px; color: var(--text-secondary); font-size: 0.8rem; text-align: center;">
                    HaldarAi &copy; 2024
                </div>
            </div>
        </div>

        <!-- Overlay for mobile sidebar -->
        <div class="overlay" id="overlay"></div>

        <!-- Main Content -->
        <div class="main-wrapper">
            <!-- Mobile Header -->
            <header class="main-header">
                <button class="icon-button" id="menu-toggle">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <div class="header-title">Inbox</div>
                <div style="flex-grow: 1;"></div>
                <button class="icon-button" id="refresh-btn">
                    <span class="material-symbols-outlined">refresh</span>
                </button>
            </header>

            <div class="content-area">
                
                <!-- HOME SCREEN (INBOX) -->
                <div id="home-screen" class="screen active">
                    <div class="content-wrapper">
                        
                        <!-- Account Card -->
                        <div class="dashboard-card">
                            <p style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 500;">Your Temporary Address</p>
                            <div id="temp-email-display" class="email-display">Generating...</div>
                            <div class="action-grid">
                                <button id="copy-btn" class="btn btn-primary">
                                    <span class="material-symbols-outlined">content_copy</span> Copy
                                </button>
                                <button id="change-mail-btn" class="btn btn-secondary">
                                    <span class="material-symbols-outlined">autorenew</span> New
                                </button>
                            </div>
                        </div>

                        <!-- Inbox List -->
                        <div class="page-header" style="justify-content: space-between;">
                            <h2>Inbox</h2>
                            <!-- Desktop Refresh Button -->
                            <button class="icon-button" id="desktop-refresh-btn" style="display: none;">
                                <span class="material-symbols-outlined">refresh</span>
                            </button>
                        </div>

                        <div id="inbox-list" class="list-container">
                            <!-- JS will inject .history-item elements here -->
                            <div id="empty-inbox" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <span class="material-symbols-outlined" style="font-size: 64px; color: var(--bg-hover);">mark_email_unread</span>
                                <p style="margin-top: 16px; font-weight: 500;">Waiting for emails...</p>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- EMAIL DETAILS SCREEN -->
                <div id="email-details-screen" class="screen">
                    <div class="content-wrapper">
                        <div class="page-header">
                            <button class="icon-button" id="back-to-inbox-btn">
                                <span class="material-symbols-outlined">arrow_back</span>
                            </button>
                            <h2 style="font-size: 1.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Message</h2>
                        </div>

                        <div class="list-container">
                            <div class="email-meta">
                                <h3 id="email-subject-header" style="font-size: 1.25rem; margin-bottom: 16px; color: var(--text-primary); font-weight: 700;"></h3>
                                <div class="meta-row">
                                    <div id="email-avatar" class="avatar"></div>
                                    <div>
                                        <div id="email-sender-name" style="font-weight: 700;"></div>
                                        <div id="email-sender-address" style="color: var(--text-active); font-size: 0.9rem; font-family: var(--font-family-code);"></div>
                                    </div>
                                    <div style="margin-left: auto; text-align: right;">
                                        <div id="email-timestamp" style="color: var(--text-secondary); font-size: 0.85rem;"></div>
                                    </div>
                                </div>
                            </div>

                            <div id="email-body" class="email-body"></div>

                            <div style="margin-top: 24px; display: flex; justify-content: flex-end;">
                                <button id="delete-message-btn" class="btn btn-danger">
                                    <span class="material-symbols-outlined">delete</span> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HISTORY SCREEN -->
                <div id="history-screen" class="screen">
                    <div class="content-wrapper">
                        <div class="page-header">
                            <h2>History</h2>
                            <button class="icon-button" id="clear-history-btn" style="margin-left: auto;">
                                <span class="material-symbols-outlined">delete_sweep</span>
                            </button>
                        </div>
                        <div id="history-list" class="list-container">
                            <!-- JS will inject items here -->
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span class="material-symbols-outlined" id="toast-icon">info</span>
        <span id="toast-message">Notification</span>
        <button id="toast-action-btn" class="toast-btn" style="display: none;">Action</button>
    </div>

    <script type="module">
        // --- STATE MANAGEMENT ---
        let state = {
            account: null,
            messages: [],
            currentMessage: null,
            lastDeletedMessage: null,
            inboxInterval: null,
            currentScreen: 'home'
        };
        let toastTimeout = null;

        // --- CONSTANTS & CONFIG ---
        const API_BASE_URL = 'https://api.mail.tm';
        const SESSION_KEY = 'haiMailSession';
        const HISTORY_KEY = 'haiMailHistory';
        const THEME_KEY = 'haiMailTheme';

        // --- DOM ELEMENTS ---
        const DOMElements = {
            splashScreen: document.getElementById('splash-screen'),
            
            // Screens
            homeScreen: document.getElementById('home-screen'),
            detailsScreen: document.getElementById('email-details-screen'),
            historyScreen: document.getElementById('history-screen'),
            
            // Sidebar & Nav
            sidebar: document.getElementById('left-sidebar'),
            menuToggle: document.getElementById('menu-toggle'),
            sidebarClose: document.getElementById('sidebar-close'),
            overlay: document.getElementById('overlay'),
            navHome: document.getElementById('nav-home'),
            navHistory: document.getElementById('nav-history'),
            
            // Theme Toggle
            themeToggle: document.getElementById('theme-toggle'),
            themeIcon: document.getElementById('theme-icon'),
            themeText: document.getElementById('theme-text'),
            
            // Home Elements
            tempEmailDisplay: document.getElementById('temp-email-display'),
            copyBtn: document.getElementById('copy-btn'),
            changeMailBtn: document.getElementById('change-mail-btn'),
            refreshBtn: document.getElementById('refresh-btn'),
            desktopRefreshBtn: document.getElementById('desktop-refresh-btn'),
            inboxList: document.getElementById('inbox-list'),
            emptyInbox: document.getElementById('empty-inbox'),

            // Details Elements
            backToInboxBtn: document.getElementById('back-to-inbox-btn'),
            deleteMessageBtn: document.getElementById('delete-message-btn'),
            emailSubjectHeader: document.getElementById('email-subject-header'),
            emailAvatar: document.getElementById('email-avatar'),
            emailSenderName: document.getElementById('email-sender-name'),
            emailSenderAddress: document.getElementById('email-sender-address'),
            emailTimestamp: document.getElementById('email-timestamp'),
            emailBody: document.getElementById('email-body'),

            // History Elements
            historyList: document.getElementById('history-list'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),

            // Toast
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            toastIcon: document.getElementById('toast-icon'),
            toastActionBtn: document.getElementById('toast-action-btn'),
        };

        // --- STORAGE FUNCTIONS ---
        const Storage = {
            saveSession: () => {
                if (state.account) localStorage.setItem(SESSION_KEY, JSON.stringify({ account: state.account, messages: state.messages }));
            },
            loadSession: () => {
                const saved = localStorage.getItem(SESSION_KEY);
                if (saved) {
                    try {
                        const session = JSON.parse(saved);
                        if (session && session.account) {
                            state.account = session.account;
                            state.messages = session.messages || [];
                            return true;
                        }
                    } catch (e) { localStorage.removeItem(SESSION_KEY); }
                }
                return false;
            },
            clearSession: () => localStorage.removeItem(SESSION_KEY),
            getHistory: () => {
                const history = localStorage.getItem(HISTORY_KEY);
                return history ? JSON.parse(history) : [];
            },
            saveToHistory: (account) => {
                if (!account || !account.address) return;
                let history = Storage.getHistory();
                history = history.filter(acc => acc.address !== account.address);
                history.unshift(account);
                if (history.length > 20) history.pop();
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            },
            removeFromHistory: (address) => {
                let history = Storage.getHistory();
                history = history.filter(acc => acc.address !== address);
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            },
            clearHistory: () => {
                localStorage.removeItem(HISTORY_KEY);
            }
        };

        // --- API FUNCTIONS ---
        async function fetchWithTimeout(resource, options = {}, timeout = 8000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(resource, { ...options, signal: controller.signal });
                clearTimeout(id);
                if (!response.ok) {
                    if (response.status === 401) {
                        showToast('Session expired. Getting new email...', 'error');
                        return null;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                clearTimeout(id);
                throw new Error(`Fetch error: ${error.message}`);
            }
        }

        async function getNewEmail(button = null) {
            if (button) showSpinner(button, true);
            Storage.saveToHistory(state.account);
            
            try {
                const domainResponse = await fetchWithTimeout(`${API_BASE_URL}/domains`);
                if (!domainResponse) throw new Error("Could not fetch domains.");
                const domains = await domainResponse.json();
                const domain = domains['hydra:member'][0].domain;

                const address = `${Math.random().toString(36).substring(7)}@${domain}`;
                const password = Math.random().toString(36).substring(2);

                const accountResponse = await fetchWithTimeout(`${API_BASE_URL}/accounts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, password }),
                });
                if (!accountResponse) throw new Error("Could not create account.");
                const accountData = await accountResponse.json();

                const tokenResponse = await fetchWithTimeout(`${API_BASE_URL}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, password }),
                });
                if (!tokenResponse) throw new Error("Could not get token.");
                const { token } = await tokenResponse.json();

                state.account = { id: accountData.id, address, password, token };
                state.messages = [];
                Storage.saveSession();
                UI.updateEmailDisplay();
                UI.renderInbox();
                startInboxPolling();
                showToast('New email address ready', 'check_circle');
            } catch (error) {
                console.error('Failed to get new email:', error);
                showToast('Error creating email. Try again.', 'error');
                UI.updateEmailDisplay();
            } finally {
                 if (button) showSpinner(button, false);
            }
        }

        async function checkInbox(manual = false) {
             if (!state.account?.token) return;
             
             if(manual) {
                 showSpinner(DOMElements.refreshBtn, true);
                 showSpinner(DOMElements.desktopRefreshBtn, true);
             }

            try {
                const response = await fetchWithTimeout(`${API_BASE_URL}/messages`, {
                    headers: { 'Authorization': `Bearer ${state.account.token}` },
                });
                
                if (!response) return;

                const data = await response.json();
                const newMessages = data['hydra:member'];
                
                newMessages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                if (newMessages.length > state.messages.length) {
                    showToast(`${newMessages.length - state.messages.length} new email(s)!`, 'mark_email_unread');
                }
                
                state.messages = newMessages;
                Storage.saveSession();
                UI.renderInbox();

            } catch (error) {
                console.error('Failed to check inbox:', error);
            } finally {
                if(manual) {
                    showSpinner(DOMElements.refreshBtn, false, 'refresh');
                    showSpinner(DOMElements.desktopRefreshBtn, false, 'refresh');
                }
            }
        }

        async function openEmail(id) {
            showToast('Loading email...', 'downloading');
            try {
                const response = await fetchWithTimeout(`${API_BASE_URL}/messages/${id}`, {
                    headers: { 'Authorization': `Bearer ${state.account.token}` },
                });
                if (!response) return;

                const message = await response.json();
                state.currentMessage = message;
                UI.renderEmailDetails(message);
                UI.navigateTo('details');
            } catch (error) {
                showToast('Could not load email.', 'error');
            }
        }

        // --- UI & UX FUNCTIONS ---
        const UI = {
            toggleTheme: () => {
                const current = document.documentElement.getAttribute('data-theme');
                const newTheme = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem(THEME_KEY, newTheme);
                UI.updateThemeIcon(newTheme);
            },
            updateThemeIcon: (theme) => {
                if (theme === 'dark') {
                    DOMElements.themeIcon.textContent = 'light_mode';
                    DOMElements.themeText.textContent = 'Light Mode';
                } else {
                    DOMElements.themeIcon.textContent = 'dark_mode';
                    DOMElements.themeText.textContent = 'Dark Mode';
                }
            },
            renderInbox: () => {
                DOMElements.inboxList.innerHTML = ''; 
                if (state.messages.length === 0) {
                    DOMElements.inboxList.appendChild(DOMElements.emptyInbox);
                } else {
                    state.messages.forEach(msg => {
                        const emailItem = document.createElement('div');
                        emailItem.className = "history-item";
                        emailItem.onclick = () => openEmail(msg.id);
                        
                        const senderName = msg.from.name || msg.from.address;
                        const senderInitial = senderName[0].toUpperCase();
                        const isNew = (Date.now() - new Date(msg.createdAt).getTime()) < 600000;
                        
                        emailItem.innerHTML = `
                            <div class="avatar ${isNew ? 'new' : ''}">${senderInitial}</div>
                            <div class="item-content">
                                <div class="item-top">
                                    <span class="sender">${escapeHTML(senderName)}</span>
                                    <span class="time">${formatDate(msg.createdAt)}</span>
                                </div>
                                <div class="subject">${escapeHTML(msg.subject || '(No Subject)')}</div>
                                <div class="snippet">${escapeHTML(msg.intro || '')}</div>
                            </div>`;
                        DOMElements.inboxList.appendChild(emailItem);
                    });
                }
            },
            renderEmailDetails: (message) => {
                DOMElements.emailSubjectHeader.textContent = message.subject || '(No Subject)';
                DOMElements.emailSenderName.textContent = message.from.name || message.from.address;
                DOMElements.emailSenderAddress.textContent = `<${message.from.address}>`;
                DOMElements.emailTimestamp.textContent = new Date(message.createdAt).toLocaleString();
                DOMElements.emailAvatar.textContent = (message.from.name || message.from.address)[0].toUpperCase();
                
                if (message.html && message.html.length > 0) {
                     DOMElements.emailBody.innerHTML = message.html[0];
                } else {
                     DOMElements.emailBody.innerHTML = `<p>${escapeHTML(message.text || '')}</p>`;
                }
            },
            renderHistory: () => {
                const history = Storage.getHistory();
                DOMElements.historyList.innerHTML = '';
                if (history.length === 0) {
                    DOMElements.historyList.innerHTML = `<div style="text-align:center; color:var(--text-secondary); padding:20px;">No history available.</div>`;
                } else {
                    history.forEach(account => {
                        const historyItem = document.createElement('div');
                        historyItem.className = "history-item";
                        historyItem.innerHTML = `
                             <div class="avatar"><span class="material-symbols-outlined" style="color:white; font-size: 20px;">history</span></div>
                             <div class="item-content">
                                <div class="sender" style="font-family:var(--font-family-code); font-size:0.9rem;">${account.address}</div>
                             </div>
                        `;
                        historyItem.onclick = () => switchToAccount(account);
                        DOMElements.historyList.appendChild(historyItem);
                    });
                }
            },
            updateEmailDisplay: () => {
                DOMElements.tempEmailDisplay.textContent = state.account ? state.account.address : 'No active email';
            },
            toggleSidebar: (forceClose = false) => {
                if (forceClose) {
                    document.body.classList.remove('left-sidebar-open');
                } else {
                    document.body.classList.toggle('left-sidebar-open');
                }
                
                if(document.body.classList.contains('left-sidebar-open')) {
                    DOMElements.sidebarClose.style.display = 'flex';
                } else {
                    DOMElements.sidebarClose.style.display = 'none';
                }
            },
            navigateTo: (screen) => {
                document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
                DOMElements.navHome.classList.remove('active');
                DOMElements.navHistory.classList.remove('active');

                if (screen === 'home') {
                    DOMElements.homeScreen.classList.add('active');
                    DOMElements.navHome.classList.add('active');
                } else if (screen === 'details') {
                    DOMElements.detailsScreen.classList.add('active');
                    DOMElements.navHome.classList.add('active');
                } else if (screen === 'history') {
                    DOMElements.historyScreen.classList.add('active');
                    DOMElements.navHistory.classList.add('active');
                }
                
                state.currentScreen = screen;
                UI.toggleSidebar(true);
            }
        };

        // --- HELPERS ---
        function copyToClipboard() {
            if (!state.account?.address) return;
            navigator.clipboard.writeText(state.account.address).then(() => showToast('Email copied to clipboard', 'content_paste'));
        }
        
        function hideToast() {
            DOMElements.toast.classList.remove('visible');
        }

        function showToast(message, iconName = 'info', action = null) {
            clearTimeout(toastTimeout);
            const { toast, toastMessage, toastIcon, toastActionBtn } = DOMElements;
            
            toastMessage.textContent = message;
            toastIcon.textContent = iconName;

            if (action && action.text && action.callback) {
                toastActionBtn.textContent = action.text;
                toastActionBtn.style.display = 'block';
                const newActionBtn = toastActionBtn.cloneNode(true);
                toastActionBtn.parentNode.replaceChild(newActionBtn, toastActionBtn);
                DOMElements.toastActionBtn = newActionBtn; 
                
                newActionBtn.addEventListener('click', () => { 
                    action.callback(); 
                    hideToast(); 
                });
            } else {
                toastActionBtn.style.display = 'none';
            }

            toast.classList.add('visible');
            toastTimeout = setTimeout(hideToast, 4000);
        }

        function showSpinner(button, show, originalIcon = '') {
            if (!button) return;
            if (show) {
                button.disabled = true;
                if(!button.dataset.originalHTML) button.dataset.originalHTML = button.innerHTML;
                button.innerHTML = '<span class="spinner"></span>';
            } else {
                button.disabled = false;
                if(button.dataset.originalHTML) {
                    button.innerHTML = button.dataset.originalHTML;
                } else if (originalIcon) {
                    button.innerHTML = `<span class="material-symbols-outlined">${originalIcon}</span>`;
                }
            }
        }

        function escapeHTML(str) {
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.round((now - date) / 1000);
            if (seconds < 60) return "Just now";
            const minutes = Math.round(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.round(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return `${Math.round(hours / 24)}d ago`;
        }
        
        function restoreLastDeletedMessage() {
            if (state.lastDeletedMessage) {
                state.messages.push(state.lastDeletedMessage);
                state.messages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                state.lastDeletedMessage = null;
                Storage.saveSession();
                UI.renderInbox();
                showToast('Message restored', 'undo');
            }
        }

        function switchToAccount(account) {
            Storage.saveToHistory(state.account);
            Storage.removeFromHistory(account.address);
            state.account = account;
            state.messages = [];
            Storage.saveSession();
            UI.updateEmailDisplay();
            UI.renderInbox();
            startInboxPolling();
            UI.navigateTo('home');
            showToast(`Switched to ${account.address}`, 'swap_horiz');
        }

        function startInboxPolling() {
            clearInterval(state.inboxInterval);
            checkInbox();
            state.inboxInterval = setInterval(() => checkInbox(false), 10000);
        }

        function addEventListeners() {
            DOMElements.navHome.addEventListener('click', () => UI.navigateTo('home'));
            DOMElements.navHistory.addEventListener('click', () => {
                UI.renderHistory();
                UI.navigateTo('history');
            });
            DOMElements.backToInboxBtn.addEventListener('click', () => UI.navigateTo('home'));

            DOMElements.menuToggle.addEventListener('click', () => UI.toggleSidebar());
            DOMElements.sidebarClose.addEventListener('click', () => UI.toggleSidebar(true));
            DOMElements.overlay.addEventListener('click', () => UI.toggleSidebar(true));
            
            // Theme Toggle
            DOMElements.themeToggle.addEventListener('click', UI.toggleTheme);

            DOMElements.copyBtn.addEventListener('click', copyToClipboard);
            DOMElements.changeMailBtn.addEventListener('click', (e) => getNewEmail(e.currentTarget));
            DOMElements.refreshBtn.addEventListener('click', () => checkInbox(true));
            if(DOMElements.desktopRefreshBtn) DOMElements.desktopRefreshBtn.addEventListener('click', () => checkInbox(true));
            
            DOMElements.clearHistoryBtn.addEventListener('click', () => {
                if(confirm("Clear all history?")) {
                    Storage.clearHistory();
                    UI.renderHistory();
                }
            });

            DOMElements.deleteMessageBtn.addEventListener('click', () => {
                if (state.currentMessage) {
                    state.lastDeletedMessage = state.currentMessage;
                    state.messages = state.messages.filter(m => m.id !== state.currentMessage.id);
                    Storage.saveSession();
                    UI.renderInbox();
                    UI.navigateTo('home');
                    showToast('Message deleted', 'delete', { text: 'Undo', callback: restoreLastDeletedMessage });
                }
            });
        }
        
        async function initApp() {
            // Theme Init
            const savedTheme = localStorage.getItem(THEME_KEY) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', savedTheme);
            UI.updateThemeIcon(savedTheme);

            addEventListeners();
            
            if(window.innerWidth >= 1024) {
                 if(DOMElements.desktopRefreshBtn) DOMElements.desktopRefreshBtn.style.display = "flex";
            }

            if (Storage.loadSession()) {
                showToast("Session restored", "restore");
            } else {
                await getNewEmail();
            }

            if (state.account) {
                UI.updateEmailDisplay();
                UI.renderInbox();
                startInboxPolling();
            }

            setTimeout(() => {
                DOMElements.splashScreen.style.opacity = '0';
                setTimeout(() => DOMElements.splashScreen.style.display = 'none', 500);
            }, 2000);
        }
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
